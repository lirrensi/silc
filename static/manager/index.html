<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SILC Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-[#1e1e1e] text-white">
    <div class="container mx-auto p-8 max-w-4xl">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-pink-400">SILC Manager</h1>
            <p class="text-gray-400 mt-2">Manage your terminal sessions</p>
        </header>

        <div class="mb-6">
            <button
                id="create-btn"
                class="px-6 py-3 bg-pink-600 hover:bg-pink-500 text-white font-medium rounded-lg transition-colors"
            >
                + New Session
            </button>
        </div>

        <div id="status" class="text-gray-400 mb-4">Loading sessions...</div>

        <div id="sessions" class="space-y-3">
            <!-- Sessions will be rendered here -->
        </div>
    </div>

    <script>
        const DAEMON_URL = 'http://127.0.0.1:19999';

        async function fetchSessions() {
            try {
                const resp = await fetch(`${DAEMON_URL}/sessions`);
                const sessions = await resp.json();
                renderSessions(sessions);
                document.getElementById('status').textContent =
                    sessions.length === 0 ? 'No active sessions' : `${sessions.length} active session(s)`;
            } catch (err) {
                document.getElementById('status').textContent = 'Failed to connect to daemon';
                console.error('Failed to fetch sessions:', err);
            }
        }

        async function createSession() {
            try {
                document.getElementById('status').textContent = 'Creating session...';
                const resp = await fetch(`${DAEMON_URL}/sessions`, { method: 'POST' });
                if (!resp.ok) {
                    throw new Error(`HTTP ${resp.status}`);
                }
                const data = await resp.json();
                document.getElementById('status').textContent = `Session created on port ${data.port}`;
                fetchSessions();
            } catch (err) {
                document.getElementById('status').textContent = `Failed to create session: ${err.message}`;
            }
        }

        function renderSessions(sessions) {
            const container = document.getElementById('sessions');
            container.innerHTML = '';

            if (sessions.length === 0) {
                container.innerHTML = `
                    <div class="text-gray-500 text-center py-8">
                        No sessions yet. Click "New Session" to create one.
                    </div>
                `;
                return;
            }

            sessions.sort((a, b) => a.port - b.port);

            for (const session of sessions) {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-[#2d2d2d] rounded-lg p-4 hover:bg-[#3d3d3d] transition-colors';

                const statusColor = session.alive ? 'bg-green-500' : 'bg-red-500';
                const idleText = session.idle_seconds < 60
                    ? `${session.idle_seconds}s idle`
                    : `${Math.floor(session.idle_seconds / 60)}m idle`;

                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-3 h-3 rounded-full ${statusColor}"></div>
                        <div>
                            <div class="font-mono text-lg">Port ${session.port}</div>
                            <div class="text-gray-400 text-sm">${session.shell} | ${session.session_id} | ${idleText}</div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button
                            class="open-btn px-4 py-2 bg-[#3e3e42] hover:bg-[#5e5e62] border border-[#5e5e62] rounded transition-colors"
                            data-port="${session.port}"
                        >
                            Open
                        </button>
                        <button
                            class="close-btn px-4 py-2 bg-red-600/20 hover:bg-red-600/40 border border-red-600/50 text-red-400 rounded transition-colors"
                            data-port="${session.port}"
                        >
                            Close
                        </button>
                    </div>
                `;
                container.appendChild(div);
            }

            // Attach event listeners
            document.querySelectorAll('.open-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const port = btn.dataset.port;
                    window.open(`http://127.0.0.1:${port}/web`, '_blank');
                });
            });

            document.querySelectorAll('.close-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const port = btn.dataset.port;
                    try {
                        await fetch(`${DAEMON_URL}/sessions/${port}`, { method: 'DELETE' });
                        fetchSessions();
                    } catch (err) {
                        console.error('Failed to close session:', err);
                    }
                });
            });
        }

        document.getElementById('create-btn').addEventListener('click', createSession);

        // Initial load
        fetchSessions();

        // Auto-refresh every 5 seconds
        setInterval(fetchSessions, 5000);
    </script>
</body>
</html>
