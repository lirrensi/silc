<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0"
        />
        <title>SILC terminal GUI</title>

        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css"
        />

        <style>
            body {
                margin: 0;
                padding: 20px;
                background: #1e1e1e;
                font-family: system-ui, sans-serif;
                height: 100vh;
                display: flex;
                flex-direction: column;
            }
            #terminal {
                flex: 1;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            }
            .status {
                color: #ffb3d9;
                text-align: center;
                padding: 8px;
                font-size: 14px;
                background: #2d1b2a;
                border-radius: 8px 8px 0 0;
            }
            .controls-container {
                padding: 15px;
                background: #252526;
                border-radius: 12px 12px 0 0;
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                justify-content: center;
            }
            .control-btn {
                padding: 8px 16px;
                background: #3e3e42;
                border: 1px solid #5e5e62;
                border-radius: 4px;
                color: #ffffff;
                font-size: 13px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s;
                min-width: 60px;
            }
            .control-btn:hover {
                background: #5e5e62;
                border-color: #ff80bf;
            }
            .control-btn.clear-btn {
                background: #d94e4e;
                border-color: #ff6b6b;
            }
            .control-btn.clear-btn:hover {
                background: #ff6b6b;
            }
            .arrow-group {
                display: flex;
                gap: 4px;
                align-items: center;
            }
        </style>
    </head>
    <body>
        <div
            class="status"
            id="status"
        >
            Connecting to WebSocket... ♡
        </div>
        <div id="terminal"></div>

        <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/lib/xterm.js"></script>

        <script>
            // Dynamic port/protocol for WS
            const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
            const host = window.location.hostname;
            const port = window.location.port || "20000"; // fallback if empty
            const wsUrl = `${protocol}//${host}:${port}/ws`;

            // Create terminal
            const term = new Terminal({
                cols: 120,
                rows: 40,
                theme: {
                    background: "#1e1e1e",
                    foreground: "#ffffff",
                    cursor: "#ff80bf",
                    selectionBackground: "#ff80bf44",
                },
                fontFamily: 'Menlo, Monaco, "Courier New", monospace',
                fontSize: 15,
                cursorBlink: true,
            });

            term.open(document.getElementById("terminal"));
            term.focus();

            // WebSocket
            const socket = new WebSocket(wsUrl);
            const statusEl = document.getElementById("status");

            socket.onopen = () => {
                statusEl.textContent = "Connected! Ready for updates ♡";
                statusEl.style.background = "#1b2d1e";
            };

            socket.onmessage = event => {
                try {
                    const msg = JSON.parse(event.data);
                    if (msg.event === "update") {
                        term.write(msg.data);
                    }
                } catch (e) {
                    // If not JSON, maybe raw data fallback?
                    term.write(event.data);
                }
            };

            socket.onclose = () => {
                statusEl.textContent = "Connection closed :(";
                statusEl.style.background = "#2d1b1b";
                term.write("\r\n\r\n--- WebSocket closed ---\r\n");
            };

            socket.onerror = err => {
                statusEl.textContent = "Connection error :(";
                statusEl.style.background = "#2d1b1b";
                console.error("WebSocket error:", err);
            };

            const sendViaWS = text => {
                if (socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({ event: "type", text, nonewline: true }));
                }
            };

            term.onData(data => {
                sendViaWS(data);
            });

            document.getElementById("ctrlc-btn").addEventListener("click", () => {
                sendViaWS("\x03");
            });

            document.getElementById("ctrld-btn").addEventListener("click", () => {
                sendViaWS("\x04");
            });

            document.querySelectorAll(".arrow-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    const key = btn.dataset.key;
                    const keyMap = {
                        up: "\x1b[A",
                        down: "\x1b[B",
                        left: "\x1b[D",
                        right: "\x1b[C",
                    };
                    sendViaWS(keyMap[key]);
                });
            });

            document.getElementById("clear-btn").addEventListener("click", async () => {
                try {
                    const port = window.location.port || "20000";
                    await fetch(`http://${window.location.hostname}:${port}/clear`, { method: "POST" });
                    term.clear();
                } catch (e) {
                    console.error("Clear failed:", e);
                }
            });
        </script>
    </body>
</html>
