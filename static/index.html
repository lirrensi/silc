<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0"
        />
        <title>SILC terminal GUI</title>

        <script src="https://cdn.tailwindcss.com"></script>
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.css"
        />

        <style>
            body {
                background: #1e1e1e;
            }
            #terminal {
                display: inline-block;
                align-self: center;
                max-width: 100%;
                max-height: calc(100vh - 180px);
                overflow: auto;
                border-radius: 12px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            }
        </style>
    </head>
    <body class="min-h-screen flex flex-col items-center p-4">
        <div
            class="w-full max-w-5xl text-center py-2 text-pink-300 text-sm bg-[#2d1b2a] rounded-t-xl font-medium"
            id="status"
        >
            Connecting to WebSocket...
        </div>
        <div id="terminal"></div>
        <div class="w-full max-w-5xl bg-[#252526] rounded-b-xl p-4 flex flex-wrap gap-3 justify-center shadow-lg">
            <button
                class="px-4 py-2 bg-[#3e3e42] border border-[#5e5e62] text-white text-sm font-medium rounded hover:bg-[#5e5e62] hover:border-pink-400 transition-all min-w-[60px]"
                id="ctrlc-btn"
            >
                Ctrl+C
            </button>
            <button
                class="px-4 py-2 bg-[#3e3e42] border border-[#5e5e62] text-white text-sm font-medium rounded hover:bg-[#5e5e62] hover:border-pink-400 transition-all min-w-[60px]"
                id="ctrld-btn"
            >
                Ctrl+D
            </button>
            <div class="flex gap-1">
                <button
                    class="arrow-btn px-3 py-2 bg-[#3e3e42] border border-[#5e5e62] text-white text-sm font-medium rounded hover:bg-[#5e5e62] hover:border-pink-400 transition-all"
                    data-key="up"
                >
                    ↑
                </button>
                <button
                    class="arrow-btn px-3 py-2 bg-[#3e3e42] border border-[#5e5e62] text-white text-sm font-medium rounded hover:bg-[#5e5e62] hover:border-pink-400 transition-all"
                    data-key="left"
                >
                    ←
                </button>
                <button
                    class="arrow-btn px-3 py-2 bg-[#3e3e42] border border-[#5e5e62] text-white text-sm font-medium rounded hover:bg-[#5e5e62] hover:border-pink-400 transition-all"
                    data-key="down"
                >
                    ↓
                </button>
                <button
                    class="arrow-btn px-3 py-2 bg-[#3e3e42] border border-[#5e5e62] text-white text-sm font-medium rounded hover:bg-[#5e5e62] hover:border-pink-400 transition-all"
                    data-key="right"
                >
                    →
                </button>
            </div>
            <button
                class="px-4 py-2 bg-red-600 border border-red-400 text-white text-sm font-medium rounded hover:bg-red-400 transition-all min-w-[60px]"
                id="clear-btn"
            >
                Clear
            </button>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/lib/xterm.js"></script>

        <script>
            (function () {
                const wsProtocol = window.location.protocol === "https:" ? "wss:" : "ws:";
                const httpProtocol = window.location.protocol === "https:" ? "https:" : "http:";
                const host = window.location.hostname;
                const port = window.location.port || "20000";
                const statusEl = document.getElementById("status");
                const token = window.prompt("Enter the SILC session token:");

                if (!token) {
                    statusEl.textContent = "Token is required to connect to this session.";
                    statusEl.style.background = "#2d1b1b";
                    return;
                }

                const authHeaders = {
                    Authorization: `Bearer ${token}`,
                };

                const wsUrl = `${wsProtocol}//${host}:${port}/ws?token=${encodeURIComponent(
                    token
                )}`;
                const httpBaseUrl = `${httpProtocol}//${host}:${port}`;

                const term = new Terminal({
                    cols: 120,
                    rows: 30,
                    scrollback: 5000,
                    theme: {
                        background: "#1e1e1e",
                        foreground: "#ffffff",
                        cursor: "#ff80bf",
                        selectionBackground: "#ff80bf44",
                    },
                    fontFamily: 'Menlo, Monaco, "Courier New", monospace',
                    fontSize: 15,
                    cursorBlink: true,
                });

                term.open(document.getElementById("terminal"));
                term.focus();

                const socket = new WebSocket(wsUrl);

                socket.onopen = () => {
                    statusEl.textContent = "Connected!";
                    statusEl.style.background = "#1b2d1e";
                };

                socket.onmessage = event => {
                    try {
                        const msg = JSON.parse(event.data);
                        if (msg.event === "update") {
                            term.write(msg.data);
                        }
                    } catch (e) {
                        term.write(event.data);
                    }
                };

                socket.onclose = () => {
                    statusEl.textContent = "Connection closed :(";
                    statusEl.style.background = "#2d1b1b";
                    term.write("\r\n\r\n--- WebSocket closed ---\r\n");
                };

                socket.onerror = err => {
                    statusEl.textContent = "Connection error :(";
                    statusEl.style.background = "#2d1b1b";
                    console.error("WebSocket error:", err);
                };

                const sendViaWS = text => {
                    if (socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify({ event: "type", text, nonewline: true }));
                    }
                };

                term.onData(data => {
                    sendViaWS(data);
                });

                const ctrlcBtn = document.getElementById("ctrlc-btn");
                if (ctrlcBtn) {
                    ctrlcBtn.addEventListener("click", () => {
                        sendViaWS("\x03");
                    });
                }

                const ctrldBtn = document.getElementById("ctrld-btn");
                if (ctrldBtn) {
                    ctrldBtn.addEventListener("click", () => {
                        sendViaWS("\x04");
                    });
                }

                document.querySelectorAll(".arrow-btn").forEach(btn => {
                    btn.addEventListener("click", () => {
                        const key = btn.dataset.key;
                        const keyMap = {
                            up: "\x1b[A",
                            down: "\x1b[B",
                            left: "\x1b[D",
                            right: "\x1b[C",
                        };
                        sendViaWS(keyMap[key]);
                    });
                });

                const clearBtn = document.getElementById("clear-btn");
                if (clearBtn) {
                    clearBtn.addEventListener("click", async () => {
                        try {
                            await fetch(`${httpBaseUrl}/clear`, {
                                method: "POST",
                                headers: authHeaders,
                            });
                            term.clear();
                        } catch (e) {
                            console.error("Clear failed:", e);
                        }
                    });
                }
            })();
        </script>
    </body>
</html>
